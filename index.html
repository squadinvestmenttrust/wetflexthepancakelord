import React, { useState, useEffect, useMemo } from 'react';
import { Search, MapPin, Star, Flame, Utensils, Filter, ArrowUpDown, Loader2, X, Info, ChevronRight } from 'lucide-react';

// --- CONFIGURATION ---
const SPREADSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZeYhMo6Lzsy-gkP-P4zjLJGinRb6EMR4vbE5pdhGnHVoUlzXtjJybyWoZ51NnCdDWvUUu_bpRD73c/pub?output=csv";

const PANCAKE_PUNS = [
  "SYRUP ME UP",
  "WITNESS THE STACK",
  "BUTTER BE GOOD",
  "FLEX THE FLUFF",
  "SOAK IT IN",
  "STACK ATTACK",
  "FLIP FOR DETAILS",
  "GLUTEN FOR PUNISHMENT",
  "GET SHORT-STACKED",
  "SQUEEZE THE BOTTLE",
  "GRIDDLE ME THIS",
  "TOTAL BATTER-Y"
];

const SyrupDrip = ({ className }) => (
  <svg viewBox="0 0 100 20" className={className} preserveAspectRatio="none">
    <path d="M0 0h100v10c-5 0-5 5-10 5s-5-5-10-5-5 5-10 5-5-5-10-5-5 5-10 5-5-5-10-5-5 5-10 5-5-5-10-5-5 5-10 5V0z" fill="currentColor" />
  </svg>
);

const App = () => {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedLocation, setSelectedLocation] = useState("All");
  const [sortBy, setSortBy] = useState("score-desc");
  const [selectedItem, setSelectedItem] = useState(null);

  // Function to reset all filters and return home
  const goHome = () => {
    setSearchQuery("");
    setSelectedLocation("All");
    setSelectedItem(null);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await fetch(SPREADSHEET_CSV_URL);
        if (!response.ok) throw new Error("Network response was not ok");
        const csvText = await response.text();
        
        const rows = csvText.split('\n').slice(1);
        const parsedData = rows.map((row, idx) => {
          const columns = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
          return {
            id: idx,
            name: columns[0]?.replace(/"/g, '') || "Unknown Diner",
            location: columns[1]?.replace(/"/g, '') || "Unknown World",
            score: parseFloat(columns[2]) || 0,
            photo: columns[3]?.replace(/"/g, '') || "https://images.unsplash.com/photo-1567620905732-2d1ec7bb7445?w=500&auto=format&fit=crop",
            // Pulling long review from Column E (index 4)
            review: columns[4]?.replace(/"/g, '') || "Wet Flex is speechless... literally. No review found."
          };
        }).filter(item => item.name && item.name.trim() !== "");

        setData(parsedData);
        setLoading(false);
      } catch (err) {
        setError("Failed to load the Pancake Lord's archives.");
        setLoading(false);
      }
    };
    fetchData();
  }, []);

  const filteredData = useMemo(() => {
    let result = data.filter(item => {
      const matchesSearch = item.name.toLowerCase().includes(searchQuery.toLowerCase()) || 
                          item.location.toLowerCase().includes(searchQuery.toLowerCase());
      const matchesLocation = selectedLocation === "All" || item.location === selectedLocation;
      return matchesSearch && matchesLocation;
    });

    if (sortBy === "score-desc") result.sort((a, b) => b.score - a.score);
    if (sortBy === "score-asc") result.sort((a, b) => a.score - b.score);
    if (sortBy === "name") result.sort((a, b) => a.name.localeCompare(b.name));

    return result;
  }, [data, searchQuery, selectedLocation, sortBy]);

  const uniqueLocations = ["All", ...new Set(data.map(item => item.location))];

  return (
    <div className="min-h-screen bg-[#4A8C6F] font-sans text-gray-900 selection:bg-amber-400">
      {/* Sticky Header */}
      <nav className="sticky top-0 z-50 bg-[#E69345] shadow-xl border-b-4 border-[#8B4513]">
        <div className="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
          <button 
            onClick={goHome}
            className="flex items-center gap-3 hover:opacity-80 transition-opacity group"
          >
            <div className="w-12 h-12 bg-amber-100 rounded-full border-2 border-amber-900 flex items-center justify-center overflow-hidden shadow-inner group-hover:rotate-12 transition-transform">
               <span className="text-2xl animate-bounce">ðŸ¥ž</span>
            </div>
            <h1 className="text-2xl md:text-3xl font-black text-white uppercase tracking-tighter drop-shadow-md italic">
              Wet Flex <span className="text-amber-100">Lord</span>
            </h1>
          </button>
          
          <div className="hidden md:flex items-center gap-4">
             <a href="#reviews" className="px-4 py-2 bg-amber-900 text-white rounded-full font-bold hover:scale-110 transition-transform active:scale-95 shadow-md">Reviews</a>
             <a href="#about" className="px-4 py-2 bg-transparent border-2 border-amber-900 text-amber-900 rounded-full font-bold hover:bg-amber-900 hover:text-white transition-all">Who is He?</a>
          </div>
        </div>
        <SyrupDrip className="absolute bottom-[-15px] left-0 w-full h-4 text-[#E69345]" />
      </nav>

      {/* Hero Section */}
      <header className="relative pt-24 pb-40 px-4 flex flex-col items-center text-center overflow-hidden">
        <div className="absolute inset-0 opacity-10 pointer-events-none">
            <div className="flex flex-wrap gap-12 rotate-12 -translate-y-20">
                {[...Array(60)].map((_, i) => <Utensils key={i} size={48} className="text-white" />)}
            </div>
        </div>

        <div className="relative z-10 max-w-4xl">
          <div className="inline-block px-4 py-1 bg-amber-400 border-2 border-amber-900 rounded-lg font-black text-amber-900 text-sm mb-6 uppercase tracking-[0.2em] shadow-[4px_4px_0px_#8B4513]">
            Certified Sticky
          </div>
          <h2 className="text-6xl md:text-[9rem] font-black text-white mb-6 leading-[0.85] drop-shadow-[0_10px_10px_rgba(0,0,0,0.3)] italic">
            STACKED <br/> <span className="text-amber-400">&</span> JACKED
          </h2>
          <p className="text-xl md:text-2xl text-white font-bold mb-10 max-w-2xl mx-auto drop-shadow-md">
            The world's only database for pancakes that actually <span className="underline decoration-amber-400 underline-offset-4">flex</span>.
          </p>
          
          <div className="bg-amber-100 p-4 rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.3)] border-4 border-amber-900 flex flex-col md:flex-row gap-4 w-full max-w-4xl mx-auto transform -rotate-1">
            <div className="relative flex-1">
              <Search className="absolute left-5 top-1/2 -translate-y-1/2 text-amber-600" />
              <input 
                type="text" 
                placeholder="Find a stack near you..."
                className="w-full pl-14 pr-4 py-5 rounded-2xl border-2 border-amber-200 focus:outline-none focus:border-amber-500 font-black bg-white text-lg placeholder:text-amber-200"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
              />
            </div>
            
            <div className="flex gap-4">
              <select 
                className="px-6 py-5 rounded-2xl border-2 border-amber-200 bg-white font-black cursor-pointer outline-none focus:border-amber-500 flex-1 md:flex-none text-amber-800"
                value={selectedLocation}
                onChange={(e) => setSelectedLocation(e.target.value)}
              >
                {uniqueLocations.map(loc => (
                  <option key={loc} value={loc}>{loc}</option>
                ))}
              </select>

              <button 
                onClick={() => setSortBy(prev => prev === 'score-desc' ? 'score-asc' : 'score-desc')}
                className="px-6 py-5 bg-amber-500 hover:bg-amber-400 text-white rounded-2xl border-b-8 border-amber-700 active:border-b-0 active:translate-y-2 transition-all flex items-center gap-2 font-black shadow-lg"
              >
                <ArrowUpDown size={24} />
              </button>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main id="reviews" className="max-w-7xl mx-auto px-4 pb-32 -mt-16 relative z-20">
        {loading ? (
          <div className="flex flex-col items-center justify-center py-32 bg-white/10 rounded-[3rem] backdrop-blur-xl border-4 border-white/20">
            <Loader2 className="w-20 h-20 animate-spin text-amber-400 mb-6" />
            <p className="text-white font-black text-2xl uppercase italic tracking-widest animate-pulse">Pre-heating the griddle...</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
            {filteredData.map((item, idx) => (
              <div 
                key={item.id} 
                className="group bg-white rounded-[2.5rem] overflow-hidden border-4 border-amber-900 shadow-[12px_12px_0px_#8B4513] hover:-translate-y-3 hover:-translate-x-1 transition-all duration-500"
              >
                <div className="relative h-72 overflow-hidden bg-amber-50">
                  <img 
                    src={item.photo} 
                    alt={item.name} 
                    className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700 brightness-95 group-hover:brightness-100"
                    onError={(e) => { e.target.src = "https://images.unsplash.com/photo-1554520735-0ad66a951bb8?w=800"; }}
                  />
                  <div className="absolute top-5 right-5 bg-amber-400 border-4 border-amber-900 px-4 py-2 rounded-2xl font-black text-xl flex items-center gap-2 shadow-xl rotate-3">
                    <Star size={20} fill="currentColor" />
                    {item.score}
                  </div>
                  <SyrupDrip className="absolute bottom-[-2px] left-0 w-full h-8 text-white rotate-180" />
                </div>

                <div className="p-8">
                  <div className="flex items-center gap-2 text-amber-600 font-black text-xs uppercase tracking-[0.2em] mb-2">
                    <MapPin size={16} />
                    {item.location}
                  </div>
                  <h3 className="text-3xl font-black text-gray-900 mb-6 leading-tight group-hover:text-amber-600 transition-colors uppercase italic tracking-tighter">
                    {item.name}
                  </h3>
                  
                  <button 
                    onClick={() => setSelectedItem(item)}
                    className="w-full py-5 bg-[#E69345] text-white rounded-2xl font-black text-lg border-b-8 border-amber-800 shadow-xl hover:bg-amber-400 hover:border-amber-600 active:border-b-0 active:translate-y-2 transition-all flex items-center justify-center gap-3 group/btn uppercase italic"
                  >
                    {PANCAKE_PUNS[idx % PANCAKE_PUNS.length]}
                    <ChevronRight className="group-hover/btn:translate-x-2 transition-transform" />
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </main>

      {/* Analysis Modal */}
      {selectedItem && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
          <div 
            className="absolute inset-0 bg-amber-900/80 backdrop-blur-md" 
            onClick={() => setSelectedItem(null)}
          />
          <div className="relative bg-white w-full max-w-3xl rounded-[3rem] border-8 border-amber-900 shadow-[20px_20px_0px_rgba(0,0,0,0.4)] overflow-hidden animate-in zoom-in duration-300">
            <button 
              onClick={() => setSelectedItem(null)}
              className="absolute top-6 right-6 z-10 p-3 bg-amber-900 text-white rounded-full hover:scale-110 active:scale-90 transition-all border-4 border-white shadow-lg"
            >
              <X size={24} />
            </button>
            
            <div className="h-72 relative bg-amber-50">
              <img src={selectedItem.photo} alt={selectedItem.name} className="w-full h-full object-cover" />
              <SyrupDrip className="absolute bottom-[-2px] left-0 w-full h-10 text-white rotate-180" />
              <div className="absolute inset-0 bg-gradient-to-t from-amber-900/40 to-transparent" />
            </div>

            <div className="p-10 max-h-[60vh] overflow-y-auto custom-scrollbar">
              <div className="flex flex-col md:flex-row justify-between items-start gap-6 mb-8">
                <div>
                  <h2 className="text-5xl font-black text-amber-900 uppercase italic leading-none mb-2">{selectedItem.name}</h2>
                  <p className="text-amber-600 text-xl font-bold uppercase tracking-widest flex items-center gap-2">
                    <MapPin size={20} /> {selectedItem.location}
                  </p>
                </div>
                <div className="bg-amber-400 border-4 border-amber-900 p-5 rounded-3xl text-center transform rotate-6 shadow-xl min-w-[120px]">
                  <p className="text-xs font-black uppercase mb-1">Stack Power</p>
                  <p className="text-5xl font-black leading-none">{selectedItem.score}</p>
                </div>
              </div>

              <div className="bg-amber-50 border-4 border-dashed border-amber-200 rounded-[2rem] p-8 relative">
                <Flame className="absolute -top-5 -left-5 text-amber-500 fill-amber-500" size={40} />
                <h4 className="text-amber-900 font-black uppercase text-base mb-4 italic underline decoration-amber-400 decoration-4">The Lord's Official Proclamation:</h4>
                <div className="text-xl font-bold text-amber-900 leading-relaxed whitespace-pre-wrap italic">
                  "{selectedItem.review}"
                </div>
              </div>

              <button 
                onClick={() => setSelectedItem(null)}
                className="mt-10 w-full py-5 bg-amber-900 text-white rounded-2xl font-black text-xl uppercase italic tracking-widest hover:bg-black transition-colors shadow-lg active:translate-y-1"
              >
                CONSIDER IT FOLDED.
              </button>
            </div>
          </div>
        </div>
      )}

      {/* About Section */}
      <section id="about" className="bg-[#E69345] py-32 border-t-8 border-amber-900 relative">
        <SyrupDrip className="absolute top-[-2px] left-0 w-full h-12 text-[#4A8C6F] rotate-180" />
        <div className="max-w-6xl mx-auto px-6 grid lg:grid-cols-2 gap-20 items-center">
            <div className="relative group">
                <div className="absolute inset-0 bg-amber-900 rounded-[4rem] translate-x-6 translate-y-6 group-hover:translate-x-3 group-hover:translate-y-3 transition-transform"></div>
                <div className="relative aspect-square bg-amber-50 rounded-[4rem] border-8 border-amber-900 overflow-hidden flex flex-col items-center justify-center p-12 text-center shadow-inner">
                    <div className="w-56 h-56 bg-amber-300 rounded-full border-8 border-amber-900 flex items-center justify-center mb-8 shadow-2xl animate-pulse">
                        <span className="text-[10rem] group-hover:scale-125 transition-transform duration-500">ðŸ¥ž</span>
                    </div>
                    <h4 className="text-5xl font-black text-amber-900 italic tracking-tighter uppercase mb-2">Wet Flex</h4>
                    <p className="font-black text-amber-800 tracking-[0.4em] uppercase text-sm">Protector of the Griddle</p>
                </div>
            </div>
            <div className="text-white">
                <h2 className="text-7xl font-black mb-10 leading-[0.9] tracking-tighter uppercase italic drop-shadow-xl">
                    THE LEGEND OF <br/>
                    <span className="text-amber-900 underline decoration-white">THE STACK</span>
                </h2>
                <div className="space-y-8 text-2xl font-bold leading-relaxed opacity-95">
                    <p>Wet Flex didn't choose the syrup life; the syrup life chose him. Born in a griddle-hot whirlwind, he dedicated his life to the pursuit of the perfect fluff-to-soak ratio.</p>
                    <p>Known for his trademark <span className="text-amber-900">"Syrup Cascade"</span>â€”pouring maple from a height of 6 feet with total muscular isolationâ€”he is the ultimate authority on breakfast excellence.</p>
                </div>
                <div className="mt-16 flex flex-wrap gap-6">
                    {[
                      { l: "Diners", v: "1.2k" },
                      { l: "Syrup", v: "400L" },
                      { l: "Fluff", v: "100%" }
                    ].map(stat => (
                      <div key={stat.l} className="p-8 bg-amber-900 rounded-3xl flex flex-col items-center flex-1 min-w-[140px] border-b-8 border-amber-950 shadow-2xl transform hover:-rotate-3 transition-transform">
                          <span className="text-5xl font-black mb-1">{stat.v}</span>
                          <span className="text-xs uppercase font-black text-amber-400 tracking-widest">{stat.l}</span>
                      </div>
                    ))}
                </div>
            </div>
        </div>
      </section>

      {/* Footer */}
      <footer className="bg-amber-900 text-amber-200 py-24 px-6 border-t-8 border-amber-950 relative overflow-hidden">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-16 relative z-10">
            <div className="text-center md:text-left">
                <p className="font-black text-white text-4xl uppercase italic mb-3 tracking-tighter drop-shadow-lg">Stay Sticky, Friends.</p>
                <p className="text-md opacity-70 font-black uppercase tracking-widest italic flex items-center justify-center md:justify-start gap-2">
                   <Utensils size={16} /> Â© 2024 Wet Flex The Pancake Lord
                </p>
            </div>
            <div className="flex gap-6">
                {['IG', 'TW', 'YT', 'TK'].map(social => (
                  <div key={social} className="w-16 h-16 bg-amber-800 rounded-2xl flex items-center justify-center hover:bg-amber-400 hover:text-amber-900 transition-all cursor-pointer border-b-8 border-amber-950 active:border-b-0 active:translate-y-2 font-black text-xl shadow-xl">
                    {social}
                  </div>
                ))}
            </div>
        </div>
        <SyrupDrip className="absolute top-0 left-0 w-full h-16 text-amber-950 opacity-50" />
      </footer>

      {/* Style overrides for the scrollbar in the modal */}
      <style>{`
        .custom-scrollbar::-webkit-scrollbar {
          width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: #fef3c7;
          border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #8b4513;
          border-radius: 10px;
        }
      `}</style>
    </div>
  );
};

export default App;
